{"version":3,"sources":["profile.js"],"names":["DMCProfilePage","root","root_","uploadButton_","querySelector","avatar_","onChange","event","files","target","length","type","indexOf","showError","reader","FileReader","onload","readerEvent","image","Image","crop","then","cropCanvas","src","toDataURL","upload","catch","error","message","result","readAsDataURL","addEventListener","onSuccess","options","minScale","width","height","SmartCrop","document","createElement","getContext","drawImage","topCrop","x","y","canvas","classList","toggle","xhr","XMLHttpRequest","open","window","location","search","setRequestHeader","getResponseHeader","snapshot","Turbolinks","Snapshot","wrap","response","href","controller","adapter","hideProgressBar","cache","put","visit","action","clearCache","status","disable","onerror","showProgressBarAfterDelay","toBlob","blob","formData","FormData","append","send","timeout","snackbarEvent","CustomEvent","dispatchEvent","removeEventListener","dmc","register"],"mappings":"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","file":"profile.js","sourcesContent":["class DMCProfilePage {\n  static attachTo(root) {\n    return new DMCProfilePage(root);\n  }\n\n  constructor(root) {\n    this.root_ = root;\n    this.uploadButton_ = this.root_.querySelector('.dmc-profile-avatar__change');\n    this.avatar_ = this.root_.querySelector('.dmc-profile-avatar__media img');\n    this.onChange = (event) => {\n      let files = event.target.files;\n      if (files.length === 0 || files[0].type.indexOf('image') === -1) {\n        this.showError('No images selected');\n      }\n\n      let reader = new FileReader();\n      reader.onload = (readerEvent) => {\n        let image = new Image();\n        image.onload = () => {\n          this.crop(image).then((cropCanvas) => {\n            this.avatar_.src=cropCanvas.toDataURL('image/png');\n            this.upload(cropCanvas);\n          }).catch((error) => {\n            this.showError(error.message || 'Image cropping error');\n          });\n        };\n        image.src = readerEvent.target.result;\n      };\n      reader.readAsDataURL(files[0]);\n    };\n\n    this.uploadButton_.addEventListener('change', this.onChange);\n  }\n\n  crop(image, onSuccess) {\n    let options = {\n      minScale: 1,\n      width: 256,\n      height: 256,\n    };\n    return SmartCrop.crop(image, options).then((result) => {\n      let cropCanvas = document.createElement('canvas');\n      cropCanvas.width = 256;\n      cropCanvas.height = 256;\n      cropCanvas.getContext('2d').drawImage(\n        image,\n        result.topCrop.x, result.topCrop.y, result.topCrop.width, result.topCrop.height,\n        0, 0, 256, 256\n      );\n      return cropCanvas;\n    });\n  }\n\n  upload(canvas) {\n    this.uploadButton_.classList.toggle('dmc-profile-avatar__change--disabled');\n\n    let xhr = new XMLHttpRequest();\n    xhr.open('POST', window.location.search, true);\n    xhr.setRequestHeader('Turbolinks-Referrer', window.location);\n\n    xhr.onload = (event) => {\n      let location = xhr.getResponseHeader('turbolinks-location');\n      let snapshot = window.Turbolinks.Snapshot.wrap(xhr.response);\n\n      if (!location) {\n        location = window.location.href;\n      }\n\n      window.Turbolinks.controller.adapter.hideProgressBar();\n      window.Turbolinks.controller.cache.put(location, snapshot);\n      window.Turbolinks.visit(location, {action: 'restore'});\n      window.Turbolinks.clearCache();\n\n      if (xhr.status > 299) {\n        Turbolinks.controller.disable();\n      }\n    };\n\n    xhr.onerror = (event) => {\n      window.Turbolinks.controller.adapter.hideProgressBar();\n      this.uploadButton_.classList.toggle('dmc-profile-avatar__change--disabled');\n      this.showError('Request error');\n    };\n\n    window.Turbolinks.controller.adapter.showProgressBarAfterDelay();\n\n    canvas.toBlob((blob) => {\n      let formData = new FormData(this.root_.querySelector('form'));\n      formData.append('avatar', blob, 'avatar.jpg');\n      xhr.send(formData);\n    });\n  }\n\n  showError(message, timeout=2000) {\n    let snackbarEvent = new CustomEvent('DMCSnackbar:show', {\n      'detail': {message: message, timeout: timeout},\n    });\n    window.dispatchEvent(snackbarEvent);\n  }\n\n  destroy() {\n    this.uploadButton_.removeEventListener('change', this.onChange);\n  }\n}\n\ndmc.register('DMCProfilePage', DMCProfilePage);\n"]}